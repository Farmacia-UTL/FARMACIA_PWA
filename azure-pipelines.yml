trigger:
  - master

pool:
  name: 'AgenteLocal'

variables:
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  PythonVersion: '3.11'

stages:
- stage: CI_Build
  displayName: 'Empaquetado + cierre de work items'
  jobs:
  - job: PythonCI
    displayName: 'Preparaci√≥n CI'
    steps:

    - script: |
        echo "üßπ Limpiando workspace..."
        git clean -xfd
      displayName: 'Limpiar workspace'

    - powershell: |
        Write-Host "üîç Detectando rama..."
        $branch = "$(Build.SourceBranchName)"

        if ($branch -ne "master") {
          Write-Host "‚è© No es master, no se cierran work items"
          exit 0
        }

        Write-Host "üßæ Buscando IDs en los commits..."
        $commits = git log --pretty=format:%s HEAD~10..HEAD
        $regex = '#(\d+)'
        $ids = @()

        foreach ($line in $commits) {
            if ($line -match $regex) {
                $ids += $matches[1]
            }
        }

        $ids = $ids | Select-Object -Unique

        if ($ids.Count -eq 0) {
            Write-Host "‚ö†Ô∏è No se detectaron tareas"
            exit 0
        }

        Write-Host "üìå IDs encontrados: $ids"

        $env:AZURE_DEVOPS_EXT_PAT = "$(System.AccessToken)"

        az extension add --name azure-devops --only-show-errors

        az devops configure --defaults `
          organization=https://dev.azure.com/ProyectoIDGS1003 `
          project="3LB-Farmacia"

        foreach ($id in $ids) {
            Write-Host "‚úîÔ∏è Cerrando tarea $id"
            az boards work-item update `
              --id $id `
              --fields "System.State=Done" `
                        "Microsoft.VSTS.Scheduling.RemainingWork=0"
        }
      displayName: 'ü§ñ Cierre autom√°tico de Work Items'
      env:
        System.AccessToken: $(System.AccessToken)

    - task: UsePythonVersion@0
      displayName: 'Configurar Python'
      inputs:
        versionSpec: '$(PythonVersion)'

    - script: |
        pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Instalar dependencias'

    - script: |
        mkdir "$(DeploymentPath)"
      displayName: 'Crear carpeta de artefactos'

    - task: CopyFiles@2
      displayName: 'Copiar archivos'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/**
          requirements.txt
          templates/**
          start.sh
        TargetFolder: '$(DeploymentPath)'

    - task: PublishPipelineArtifact@1
      displayName: 'Publicar Artefacto'
      inputs:
        targetPath: '$(DeploymentPath)'
        artifact: '$(ArtifactName)'
