# =====================================================
# ğŸ“¦ Pipeline CI para App Flask (SGT) - Solo Build
# Flujo: CI (Empaquetado) -> Artefacto listo
# =====================================================

trigger:
- master

pool:
  name: 'AgenteLocal'

variables:
  AppSourceDir: '$(Build.SourcesDirectory)/sgt'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  # ServiceConnectionName y AppServiceName ya no son necesarios sin deploy, 
  # pero los dejo comentados por si los re-activas en el futuro.
  # ServiceConnectionName: 'AZ-Conexion-SGT'
  # AppServiceName: 'sgt-app-integrated-2025'
  PythonVersion: '3.11' # âœ… VersiÃ³n centralizada

# =====================================================
# 1ï¸âƒ£ Etapa: CI - IntegraciÃ³n Continua (Empaquetado)
# =====================================================
stages:
- stage: CI_Build
  displayName: 'Etapa 1: IntegraciÃ³n Continua (Empaquetado)'
  jobs:
  - job: PythonCI
    displayName: 'Job: InstalaciÃ³n y Empaquetado'
    steps:

    - script: |
        echo "ğŸ” Detectando rama..."
        if [ "$(Build.SourceBranchName)" != "master" ]; then
          echo "â© No es main. No se cierran tareas."
          exit 0
        fi

        echo "ğŸ§° Instalando Azure CLI..."
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

        az extension add --name azure-devops || true

        echo "ğŸ”— Configurando DevOps CLI..."
        az devops configure --defaults \
          organization=https://dev.azure.com/ProyectoIDGS1003 \
          project="3LB-Farmacia"

        echo "ğŸ§¾ Obteniendo IDs de work items desde los commits..."
        git log --pretty=format:%s HEAD~10..HEAD \
          | grep -oE '#[0-9]+' | sort -u | tr -d '#' > wi.txt

        echo "ğŸ“Œ IDs detectados:"
        cat wi.txt

        for ID in $(cat wi.txt); do
          echo "âœ”ï¸ Cerrando Work Item $ID..."
          az boards work-item update \
           --id $ID \
           --fields "System.State=Done" \
                    "Microsoft.VSTS.Scheduling.RemainingWork=0"
        done
      displayName: "ğŸ¤– Cierre automÃ¡tico de Work Items"