# =====================================================
# üì¶ Pipeline CI para App Flask (SGT) - Solo Build
# Plataforma: Windows (AgenteLocal)
# Flujo:
#   1. CI: Build + Cierre autom√°tico de Work Items (PowerShell)
#   (Se elimin√≥ el despliegue a Azure)
# =====================================================

trigger:
- master  # ‚ö†Ô∏è Aseg√∫rate de que esta sea tu rama principal

pool:
  name: 'AgenteLocal'

variables:
  # Rutas y Nombres
  AppSourceDir: '$(Build.SourcesDirectory)/sgt'
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  
  # ‚¨áÔ∏è Variables de Azure (Comentadas porque no se usar√°n)
  # ServiceConnectionName: 'AZ-Conexion-SGT'
  # AppServiceName: 'sgt-app-integrated-2025'
  
  # Configuraci√≥n
  PythonVersion: '3.11'

# =====================================================
# ETAPAS DEL PIPELINE
# =====================================================
stages:

# -----------------------------------------------------
# 1Ô∏è‚É£ ETAPA 1: CI - Integraci√≥n Continua (Build)
# -----------------------------------------------------
- stage: CI_Build
  displayName: 'Etapa 1: Empaquetado y Gesti√≥n (CI)'
  jobs:
  - job: PythonCI
    displayName: 'Job: Preparaci√≥n'
    steps:

    # 1.1 Limpieza del √°rea de trabajo
    - script: |
        echo "üßπ Limpiando workspace..."
        git clean -xfd
      displayName: 'Limpiar workspace'

    # 1.2 ü§ñ SCRIPT CORREGIDO: Cierre autom√°tico de Work Items (PowerShell para Windows)
    # üõë NOTA: Se usa 'powershell' expl√≠citamente para evitar errores de CMD
    - powershell: |
        Write-Host "üîç Detectando rama..."
        $branch = "$(Build.SourceBranchName)"
        
        # Validamos si es master
        if ($branch -ne "master") {
          Write-Host "‚è© La rama es '$branch'. Solo se cierran tareas en 'master'. Saltando..."
          exit 0
        }

        Write-Host "üß∞ Verificando herramientas Azure CLI..."
        try {
          az --version | Out-Null
        } catch {
          Write-Warning "‚ö†Ô∏è Azure CLI no encontrado. Aseg√∫rate de instalarlo en el agente."
        }

        # Instala la extensi√≥n de devops si falta
        az extension add --name azure-devops 2>$null

        Write-Host "üîó Configurando conexi√≥n a DevOps..."
        az devops configure --defaults organization=https://dev.azure.com/ProyectoIDGS1003 project="3LB-Farmacia"

        Write-Host "üßæ Buscando IDs de tareas (#123) en los √∫ltimos commits..."
        # Obtiene mensajes de los √∫ltimos 10 commits
        $commits = git log --pretty=format:%s HEAD~10..HEAD
        
        # Regex para buscar #NUMERO
        $regex = '#(\d+)'
        $ids = @()
        
        foreach ($line in $commits) {
            if ($line -match $regex) {
                $ids += $matches[1]
            }
        }
        
        # Filtra duplicados
        $ids = $ids | Select-Object -Unique

        if ($ids.Count -eq 0) {
            Write-Host "‚ö†Ô∏è No se detectaron IDs de tareas en los commits recientes."
            exit 0
        }

        Write-Host "üìå IDs encontrados para cerrar: $ids"

        # Autenticaci√≥n con el token del sistema
        $env:AZURE_DEVOPS_EXT_PAT = "$(System.AccessToken)"

        foreach ($id in $ids) {
            Write-Host "‚úîÔ∏è Cerrando Work Item #$id..."
            # Actualiza estado a Done y RemainingWork a 0
            az boards work-item update --id $id --fields "System.State=Done" "Microsoft.VSTS.Scheduling.RemainingWork=0"
        }
      displayName: "ü§ñ Cierre autom√°tico de Work Items"
      env:
        AZURE_DEVOPS_EXT_PAT: $(System.AccessToken) # üîë Permiso cr√≠tico

    # 1.3 Configurar Python
    - task: UsePythonVersion@0
      displayName: 'Configurar Python $(PythonVersion)'
      inputs:
        versionSpec: '$(PythonVersion)'

    # 1.4 Instalar Dependencias
    - script: |
        echo "üì¶ Instalando dependencias..."
        pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Instalar dependencias'

    # 1.5 Crear carpeta temporal
    - script: |
        mkdir -p "$(DeploymentPath)"
        echo "Directorio creado: $(DeploymentPath)"
      displayName: 'Crear carpeta de artefactos'

    # 1.6 Copiar archivos al paquete
    - task: CopyFiles@2
      displayName: 'Copiar Archivos al Artefacto'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/** requirements.txt 
          templates/** start.sh         
        TargetFolder: '$(DeploymentPath)'

    # 1.7 Publicar Artefacto
    - task: PublishPipelineArtifact@1 
      displayName: 'Publicar Artefacto'
      inputs:
        targetPath: '$(DeploymentPath)' 
        artifact: '$(ArtifactName)'