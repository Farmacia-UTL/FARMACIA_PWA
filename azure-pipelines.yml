# =====================================================
# üì¶ Pipeline CI para App Flask (SGT) - Solo Build + Cierre Tareas
# =====================================================

trigger:
- master # O 'main'

pool:
  name: 'AgenteLocal'

variables:
  ArtifactName: 'sgt-deploy-package'
  DeploymentPath: '$(Build.ArtifactStagingDirectory)/$(ArtifactName)'
  PythonVersion: '3.11'

stages:
- stage: CI_Build
  displayName: 'Empaquetado y Gesti√≥n'
  jobs:
  - job: PythonCI
    displayName: 'Job: Preparaci√≥n CI'
    steps:

    # 0. ‚úÖ Descargar historial completo
    - checkout: self
      fetchDepth: 0

    # 1. Limpieza
    - script: |
        echo "üßπ Limpiando workspace..."
        git clean -xfd
      displayName: 'Limpiar workspace'

    # 2. ü§ñ Cierre autom√°tico de Tareas (Script Depurado)
    - powershell: |
        Write-Host "üîç INICIANDO DIAGN√ìSTICO..."
        $branch = "$(Build.SourceBranchName)"
        Write-Host "   -> Rama detectada: $branch"

        if ($branch -ne "master" -and $branch -ne "main") {
          Write-Host "‚è© No estamos en master/main. Saltando."
          exit 0
        }

        # Validaci√≥n de seguridad: ¬øExiste el comando 'az'?
        if (-not (Get-Command az -ErrorAction SilentlyContinue)) {
            Write-Warning "‚ö†Ô∏è El comando 'az' no funciona. Reinicia el agente."
            exit 0
        }

        Write-Host "üßæ Leyendo √∫ltimos 15 commits..."
        # Usamos -n 15 para evitar errores si hay pocos commits
        $commits = git log -n 15 --pretty=format:%s
        
        Write-Host "--------------------------------"
        Write-Host "   MENSAJES ENCONTRADOS:"
        $commits | ForEach-Object { Write-Host "   * $_" }
        Write-Host "--------------------------------"
        
        $regex = '#(\d+)'
        $ids = @()

        foreach ($line in $commits) {
            if ($line -match $regex) {
                $id = $matches[1]
                Write-Host "   -> ¬°Detectado ID #$id en el mensaje!"
                $ids += $id
            }
        }
        
        $ids = $ids | Select-Object -Unique

        if ($ids.Count -eq 0) {
            Write-Host "‚ÑπÔ∏è No encontr√© ning√∫n s√≠mbolo '#' seguido de n√∫meros en los mensajes de arriba."
            exit 0
        }

        Write-Host "üìå Intentando cerrar IDs: $ids"

        $env:AZURE_DEVOPS_EXT_PAT = "$(System.AccessToken)"
        
        # Login expl√≠cito para asegurar permisos
        echo $env:AZURE_DEVOPS_EXT_PAT | az devops login --organization https://dev.azure.com/ProyectoIDGS1003

        az devops configure --defaults organization=https://dev.azure.com/ProyectoIDGS1003 project="3LB-Farmacia"

        $hasError = $false

        foreach ($id in $ids) {
            Write-Host "üîÑ Procesando Tarea #$id..."
            try {
                # Intentamos actualizar. Si falla, capturamos el error.
                # Usamos --output json para que no llene la pantalla, a menos que falle.
                az boards work-item update --id $id --fields "System.State=Done" "Microsoft.VSTS.Scheduling.RemainingWork=0" 2>&1 | Out-String -OutVariable azOutput
                
                if ($LASTEXITCODE -eq 0) {
                    Write-Host "   ‚úÖ ¬°Tarea #$id cerrada con √©xito!" -ForegroundColor Green
                } else {
                    throw $azOutput
                }
            } catch {
                Write-Error "‚ùå ERROR CR√çTICO al cerrar tarea #$id"
                Write-Error $_
                Write-Warning "üí° SOLUCI√ìN: Probablemente el 'Build Service' no tiene permiso para editar tareas."
                $hasError = $true
            }
        }
        
        if ($hasError) {
            Write-Error "üí• Hubo errores al cerrar tareas. Revisa los permisos (Ver instrucciones)."
            exit 1
        }

      displayName: 'ü§ñ Cierre autom√°tico de Work Items'
      env:
        AZURE_DEVOPS_EXT_PAT: $(System.AccessToken) 

    # 3. Configurar Python
    - task: UsePythonVersion@0
      displayName: 'Configurar Python'
      inputs:
        versionSpec: '$(PythonVersion)'

    # 4. Instalar Dependencias
    - script: |
        pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Instalar dependencias'

    # 5. Crear Artefacto
    - script: |
        mkdir "$(DeploymentPath)"
      displayName: 'Crear carpeta de artefactos'

    # 6. Copiar Archivos
    - task: CopyFiles@2
      displayName: 'Copiar archivos'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          sgt/**
          requirements.txt
          templates/**
          start.sh
        TargetFolder: '$(DeploymentPath)'

    # 7. Publicar
    - task: PublishPipelineArtifact@1
      displayName: 'Publicar Artefacto'
      inputs:
        targetPath: '$(DeploymentPath)'
        artifact: '$(ArtifactName)'